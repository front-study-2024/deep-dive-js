# 38장 브라우저의 렌더링 과정

- 대부분의 프로그래밍 언어는 OS나 VM 위에서 실행, JS는 브라우저에서 실행
1. 브라우저는 HTML,CSS,JS 리소스를 요청하고 서버로 응답받는다
2. 브라우저 렌더링 엔진은 DOM 트리와 CSSOM 트리를 결합하여 렌더 트리를 만든다.
3. 브라우저의 JS엔진은 서버로 부터 응답된 JS를 파싱하여 AST를 생성하고 바이트 코드로 변환하여 실행, 이때 JS는 DOM API를 통해 DOM 혹은 CSSOM을 변경함. 이 변경된 트리는 다시 렌더트리로 결합.
4. 렌더트리를 기반으로 브라우저에 페인팅

## 38.1 요청과 응답

- 필요한 리소스(HTML,CSS,JS,이미지)를 요청하고 서버로 부터 응답
- 서버는 루트요청에 대해 루트폴더에 존재하는 정적파일 index.html을 응답
- HTML 파싱중에 필요한 리소스가 필요하면 서버로 요청하며 파싱을 중단한다.

### 38.2 HTTP1.1과 HTTP2.0

- HTTP1.1은 기본적으로 커넥션 당 하나의 요청과 응답 처리
- HTTP2.0은 다중 전송 및 다중 응답이 가능

### 38.3 HTML 파싱과 DOM 생성

- html은 단순 텍스트 이지만 이를 브라우저가 이해하도록 객체(DOM)으로 변환해야한다.
1. HTML 파일을 요청받으면 서버는 이 요청파일을 읽어 메모리에 저장한 뒤 저장된 바이트를 인터넷을 통해 경유하여 응답
2. 브라우저는 이 바이트 형태로 응답을 받고. 해당 meta태그로 인코딩을 한다.(이러한 메타태그는 http 응답 헤더에 담겨 있다.)
3. 문자열로 변환된 HTML을 읽어 코드의 최소단위인 토큰들로 분해한다.
4. 각 토큰을 객체로 변환하고 노드들을 생성.
5. HTML문서는 HTML 요소들의 집합으로 이루어지며 이 요소는 중첩관계를 갖는다. 이 노드들을 트리 자료구조로 구성하고 이 구조를 DOM이라고 한다.

## 38.4 CSS 파싱과 CSSOM 생성

- 렌더링엔진은 HTML 코드를 한줄씩 순차적으로 파싱한다. 이떄 필요한 리소스(CSS,JS,Link태그) 를 만나면 중단된다.
- CSS파일을 만나면 이 파일을 파싱을하여 CSSOM 트리를 생성하고 난 뒤 HTML은 파싱이 중단된 지점부터 다시 파싱을 시작한다.
- 해석 과정은 (바이트 → 문자 → 토큰 → 노드 → CSSOM)

## 38.5 렌더 트리 생성

- DOM과 CSSOM이 결합하여 렌더 트리로 결합된다.
- 렌더트리는 브라우저 화면에 렌더링 되는 노드만으로 구성된다.
- 이 렌더트리는 각 HTML 요소의 레이아웃을 계산하는데 사용되며 브라우저 화면에 픽셀을 렌더링하는 페인팅 처리에 입력된다.
- 레이아웃 계산과 페인팅을 다시 실행하는 리렌더링은 비용이 많이드는 작업이다.

## 38.6 자바스크립트 파싱과 실행

- JS에서는 DOM API를 활용하여 DOM을 동적으로 조작가능
- script 태그를 만나면 렌더링 엔진으로 부터 제어권을 넘겨받아 JS 엔진이 JS코드를 파싱한다.
- 이 JS는 코드를 파싱한 후 AST 를 생성한다.
    
1. JS 코드를 문법적 의미 단위인 토큰으로 분리한다.
2. 이 토큰들을 AST로 생성한다. AST는 토큰에 문법적 의미와 구조를 반영한 트리구조이다.
3. 이 AST트리를 바이트코드로 변환하여 인터프리터가 실행한다.

## 38.7 리플로우와 리페인트

- 리플로우는 레이아웃을 새로 계산하는것
- 리페인트는 재 결합된 렌더트리를 기반으로 다시 페인트
- 레이아웃에 영향이 없는 경우 리플로우를 건너 뛸 수 있다.

### 38.8 자바스크립트 파싱에 의한 HTML 파싱 중단

- 스크립트 태그의 위치를 잘못 두면 HTML DOM 조작에 문제가 생길 수 있어 가장 하단에 두는것이 좋다.

## 38.9 script 태그의 async/defer 어트리뷰트

- async와 defer 어트리뷰트는 다음과 같이 src 어트리뷰트를 통해 외부 자바스크립트 파일을 로드하는 경우에 사용 가능
- 이를 통해 비동기적으로 파일을 불러올 수 있다.
- async 어트리뷰트는 로드가 완료된 직후에 실행이 된다. 이때 HTML 태그 파싱이 중단된다.
- defer 어트리뷰트는 HTML 파싱과 JS 로드가 비동기적으로 실행되지만 HTML 파싱 이후에 JS가 실행이 된다.
